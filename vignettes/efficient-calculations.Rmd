---
title: "Efficient calculation"
output: rmarkdown::html_vignette
#output: pdf_document
vignette: >
  %\VignetteIndexEntry{Efficient calculation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

There are a few ways to run simulations using this package. 
The easiest way is,  as expected,  not necessarily the most efficient way. So depending on your use cases, you might want to use a different approach than the one
described in [Run Simulations](run-simulation.html)

This vignettes aims at describing some scenarios and the suggested method to efficiently run the simulations

## Life cycle of a simulation run

In general, a user loads a simulation in order to set some parameters, calculate the simulation and get some results. 
Here are some steps inherent to each simulation 

1. Loading a simulation
2. Optional: Setting parameter values
3. Optional: Setting initial values
4. Initializing the simulation engine
5. Solving the ODE System (calculating the outputs)

Depending on the simulation of interest, some steps might take much longer than others. For example, a simulation with multiple administrations simulated over many months will load and initialize quickly (1 and 4) while calculating (5) will be the critical step. On the other hand, a simulation with dozens of compounds will also take time to load and initialize (1 and 4). 


## Running a single simulation once

This is by far the easiest use cases. A simulation is loaded from a pkml file and the outputs are calculated. In this use case, step 4 and 5 are lumped together in one single call
See [Run Simulations](run-simulation.html) for more details. 


## Running a single simulation multiple times and varying some parameters/initial values between each run

This is already a use case where the optimal and most efficient way depends drastically on the simulation at hand.
Let say you want to calculate the outputs of a simulation for different doses

A simple implementation could be something like this, where we load the simulation once, set the dose value and calculate for each dose of interest. 
```{r SequentialRun, eval=TRUE}
library(ospsuite)
# Load and run the simulation
simFilePath <- system.file("extdata", "Aciclovir.pkml", package = "ospsuite")
sim <- loadSimulation(simFilePath)
doseParameter <- getAllParametersMatching(toPathString("Applications", "**", "Dose"), sim)[[1]]

# run for dose 100mg
doseParameter$value <- toBaseUnit(doseParameter, 100, "mg")
result100 <- runSimulations(simulations = sim)

# run for dose 200mg
doseParameter$value <- toBaseUnit(doseParameter, 200, "mg")
result200 <- runSimulations(simulations = sim)

# ...

# run for dose 500mg
doseParameter$value <- toBaseUnit(doseParameter, 500, "mg")
result500 <- runSimulations(simulations = sim)
```

This implementation is very easy to understand, but has potentially one big performance bottleneck. Each simulation run is performed sequentially. 
That means that you wont have any performance boost from having multiple core on your machine.
If the simulation only takes a few seconds to run, this solution is absolutely acceptable. However, let's assume that a simulation takes 1h to run. This code would take over 5h to run, as each `runSimulations` call would be executed sequentially. 

A better way, when the simulation run time (5) is much greater than the loading time (1) and initialization time (4), is to load the simulation multiple times and run the simulation concurrently (e.g. in parallel)

Consider the following implementation
```{r ParallelRun, eval=TRUE}
library(ospsuite)
# Load and run the simulation
simFilePath <- system.file("extdata", "Aciclovir.pkml", package = "ospsuite")

loadSimulationWithDose <- function(doseInMg) {
  sim <- loadSimulation(simFilePath, loadFromCache = FALSE)
  doseParameter <- getAllParametersMatching(toPathString("Applications", "**", "Dose"), sim)[[1]]
  doseParameter$value <- toBaseUnit(doseParameter, doseInMg, "mg")
  return(sim)
}

# Creates 5 instances of a simulation (This is very fast for typical simulations)
sim100 <- loadSimulationWithDose(doseInMg = 100)
sim200 <- loadSimulationWithDose(doseInMg = 200)
sim300 <- loadSimulationWithDose(doseInMg = 300)
sim400 <- loadSimulationWithDose(doseInMg = 400)
sim500 <- loadSimulationWithDose(doseInMg = 500)


# Runs the simulation in parallel
results <- runSimulations(simulations = list(sim100, sim200, sim300, sim400, sim500))

# Results in now a list of SimulationResults
```

This implementation is also fairly straight forward. We load the simulation multiple times from file (note the usage of `loadFromCache=FALSE` to ensure that we always get a new instance of a simulation and not the same instance) and we set the dose. Then, we call the `runSimulations` function with the list of simulations. The engine will run these simulations in parallel, which means that the overall execution time should be slightly more than 1h, as each run would be executed **at the same time**.


## Running one or more simulations multiple times in a loop

This is a more advanced use case, typically when implementing some kind of optimization or sensitivity algorithms. The ospsuite-r package introduces the concept of a **simulation batch**. With a simulation batch, you specify not only the simulation to run, but also which parameters will be varied between each run. This allows the simulation engine to speed up the system significantly as some equations can be rewritten and simplified. A simulation batch also keeps the simplified simulation in memory. That means that running a simulation again with a new set of values will be much faster, as the initialization phase (4) is only done if required and not for every run. Consider the following code:

```{r BatchRun, eval=TRUE}
library(ospsuite)
simFilePath <- system.file("extdata", "Aciclovir.pkml", package = "ospsuite")

# We create two different instances of the same simulation to illustrate the usage.
sim1 <- loadSimulation(simFilePath, loadFromCache = FALSE)
sim2 <- loadSimulation(simFilePath, loadFromCache = FALSE)

# define the list of parameter that will be varied in the run. We will vary 2 parameters: Lipophilicity and Permeability 
parameterPaths <- c("Aciclovir|Lipophilicity", "Aciclovir|Permeability")

# define a first simulation batch
simBatch1 <- createSimulationBatch(simulation = sim1, parametersOrPaths = parameterPaths)

# For this new batch, we will vary Molecular Weight
simBatch2 <- createSimulationBatch(simulation = sim2, parametersOrPaths = c("Aciclovir|Molecular weight"))

simulationBatches <- list(simBatch1, simBatch2)
# now setting some parameter run values (the size of the array should match the number of parameters to vary for each batch
simBatch1$addRunValues(parameterValues = c(1, 2))
simBatch1$addRunValues(parameterValues = c(3, 4))
simBatch1$addRunValues(parameterValues = c(5, 6))

# We only have one parameter to vary for simBatch2, therefor only one value to set
simBatch2$addRunValues(parameterValues = 150)
simBatch2$addRunValues(parameterValues = 200)
simBatch2$addRunValues(parameterValues = 300)
simBatch2$addRunValues(parameterValues = 400)


# So far, we created 2 simulation batches, one with 3 parameter sets and the other one with 4. That means that 3 run slots will be allocated for simBatch1 and 4 will be allocated for simBatch2. These slots will remain in memory until the batch object is discarded

# Now we run the simulation batches. By doing so, 7 runs (3 for simBatch1 and 4 for simBatch2) will be executed in parallel. 
# Please see documentation of runSimulationBatches for more details on how to match parameter set to results.
results <- runSimulationBatches(simulationBatches)

# We can now set more values to the batches and run them again. Note that we do not have to always set the same number of values at the same time
simBatch1$addRunValues(parameterValues = c(10, 20))
simBatch1$addRunValues(parameterValues = c(30, 40))
simBatch2$addRunValues(parameterValues = 500)
simBatch2$addRunValues(parameterValues = 200)

# this run will be much faster as the simulation won't be initialized again. Only the new value will be set as specified when adding new run values with addRunValues
results2 <- runSimulationBatches(simulationBatches)

# Once you are done with your simulation batches, you can free the allocated memory by removing them from the environment. This will be done automatically when your R session is terminated.
rm(simBatch1)
rm(simBatch2)
```

Usage of `SimulationBatch` is recommended for advanced scenarios where you are expecting to run simulations hundreds of times and where each second that you can spare will impact the performance significantly. 
