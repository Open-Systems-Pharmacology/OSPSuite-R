---
title: "Working with `DataCombined`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with `DataCombined`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

In Modeling and Simulation workflow, we often need to work multiple observed and/or simulated datasets. Further, some of these datasets can be clubbed together in a group for analysis and visualization.

The `DataCombined` class in `{ospsuite}` provides a container to store these datasets, to group them, and to transform them further.

Before we see how, let's first create an observed and a simulated dataset.

```{r}
library(ospsuite)

# simulated data
simFilePath <- system.file("extdata", "Aciclovir.pkml", package = "ospsuite")
sim <- loadSimulation(simFilePath)
simResults <- runSimulation(sim)
outputPath <- "Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood)"

# observed data
obsData <- lapply(
  c("ObsDataAciclovir_1.pkml", "ObsDataAciclovir_2.pkml", "ObsDataAciclovir_3.pkml"),
  function(x) loadDataSetFromPKML(system.file("extdata", x, package = "ospsuite"))
)
names(obsData) <- lapply(obsData, function(x) x$name)
```

## Creating `DataCombined` object

First, we create a new instance of `DataCombined` class.

```{r}
myDataCombined <- DataCombined$new()
```

Then we add simulated results to this object using `$addSimulationResults()`:

```{r}
myDataCombined$addSimulationResults(
  simulationResults = simResults,
  quantitiesOrPaths = outputPath,
  groups = "Aciclovir PVB"
)
```

Next we add observed data to this object using `$addDataSets()`:

```{r}
myDataCombined$addDataSets(
  obsData$`Vergin 1995.Iv`, 
  groups = "Aciclovir PVB"
)
```

There are a few things to keep in mind here:

- It doesn't matter the order in which observed or simulated datasets are added.
- You can add multiple `DataSet` objects in `$addDataSets()` method call.
- You can add only a single instance of `SimulationResults` in `$addSimulationResults()` method call.
- If you add a dataset and then add it one more time, the latter will replace the former. `DataCombined` uses name of the dataset as an identifier to check for uniqueness. 

## Grouping

If you do not specify `groups` when you add datasets and wish to do so later, you can use the `$setGroups()` method.

At any point, you can check the current groupings with the following active field:

```{r}
myDataCombined$groupMap
```


## Extracting a combined data frame

Internally, this object extracts data frames for observed and simulated datasets and combines them.

```{r}

```


https://pillar.r-lib.org/reference/pillar_options.html

## Visualizations with `DataCombined`

You can visualize the data stored in a `DataCombined` object. See `vignette("data-combined-plotting")` describing this functionality.
