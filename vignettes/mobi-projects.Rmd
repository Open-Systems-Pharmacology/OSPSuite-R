---
title: "Working with MoBi projects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with MoBi projects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Working with MoBi projects

First, load a MoBi project:

```{r loadProject}
projectPath <- system.file("extdata", "TH_QST_Platform.mbp3", package = "ospsuite")
myProject <- loadMoBiProject(projectPath)
```

We can browse the contents of the project, e.g., get the list of simulations in the project:

```{r getSimulationNames, execute = FALSE}
simulationsInProject <- myProject$simulationNames

# EXPECTED BEHAVIOR
simulationsInProject <- c("Thyroid_QST_Human", "Thyroid_QST_Phenobarbital")

print(simulationsInProject)
```

get the list of parameter identifications:

```{r getPInNames, execute = FALSE}
PIs <- myProject$ParameterIdentificationNames

# EXPECTED BEHAVIOR
PIs <- c()

print(PIs)
```

get observed data from the project as `DataSet` objects:

```{r getObservedData}
obsData <- myProject$getObservedData()

print(names(obsData))
```

get the list of individuals and expression profiles from the project:

```{r getIndividualsExpressions}
individualsInProject <- myProject$Individuals
expProfilesInProject <- myProject$ExpressionProfiles

# EXPECTED BEHAVIOR
individualsInProject <- c("Human", "Rat")
expProfilesInProject <- c("UDPGT1|Human|Healthy",
                          "DIO1|Human|Healthy",
                          "DIO3|Human|Healthy",
                          "UDPGT2|Human|Healthy",
                          "UGT1A1|Rat|Healthy",
                          "PB-LiverBindingPartner|Human|Healthy")
```


get the modules present in the project:

```{r getModulesNames}
modulesInProject <- myProject$Modules

# EXPECTED BEHAVIOR
names(modulesInProject) <- c("Endogenous_TH",
                             "Phenobarbital_Extension",
                             "Phenobarbital_PBPK",
                             "Pituitary",
                             "Rat physiology",
                             "TH_activeTransports",
                             "TH_plasma_binding",
                             "Thyroid",
                             "Thyroid_QST")

```

and get the building blocks defined for the modules:

```{r getBuildingBlocksFromModule}
bbs <- modulesInProject[["Thyroid"]]$getBuildingBlocks()

for (bbName in names(bbs)){
  print(name, ": ", bbs[[name]]$type)
}

# Get all parameter values BBs
paramValuesBBs <- modulesInProject[["Thyroid"]]$getBuildingBlocks(type = "Parameter Values")
```

We can retrieve simulations from the project:

```{r getSimulation}
simulation <- myProject$getSimulation[[simulationsInProject[[1]]]]
```

and the observed data as `DataSet` objects:

```{r getObservedData}
obsData <- myProject$getObservedData()
```

## Creating simulations

The user can create new simulation from the modules available in the project. In this example,
we create a simulation for the rat species from the modules "Thyroid_QST", "Rat physiology", "Thyroid", "Pituitary", "Endogenous_TH", "TH_activeTransports", and "TH_plasma_binding". We will
select the expression profiles "UDPGT1|Human|Healthy", "DIO1|Human|Healthy", "DIO3|Human|Healthy",
"UDPGT2|Human|Healthy", and specify the parameter values building block "Rat" from the 
module "Thyroid":

```{r createSimulationFromProject}
sim1 <- createSimulation(simulationName = "Thyroid_QST_rat", 
                         modulesNames = c("Thyroid_QST",
                                          "Rat physiology",
                                          "Thyroid",
                                          "Pituitary",
                                          "Endogenous_TH",
                                          "TH_activeTransports",
                                          "TH_plasma_binding"),
                        individualName = "Rat",
                        expressionProfilesNames = c("UDPGT1|Human|Healthy",
                                                    "DIO1|Human|Healthy", 
                                                    "DIO3|Human|Healthy",
                                                    "UDPGT2|Human|Healthy"),
                        selectedParameterValues = list("Thyroid" = "Rat")
)
```

An alternative to creating simulations from modules from a project is to use the 
function `createSimulationFromModules()` and provide a list of `Module` objects. 
This allows to create simulations from modules contained in different projects,
or from modules that are stored as pkml files. In the following example, we will
create a simulation using the modules from the project as in the example before,
but the extension module "Thyroid" will be loaded from a pkml file, and a new individual will
be created.

```{r createSimulationFromModules}
# Get modules from the project
modules <- myProject$getModules()
# Get the expression profiles from the project
expressionProfiles <- myProject$getExpressionProfiles(names = c("UDPGT1|Human|Healthy",
                                                    "DIO1|Human|Healthy", 
                                                    "DIO3|Human|Healthy",
                                                    "UDPGT2|Human|Healthy"))
# Create an individual building block
myIndividual <- createIndividualBuildingBlock(species = Species$Human,
                                              population = HumanPopulation$Asian_Tanaka_1996,
                                              gender = Gender$Male,
                                              weight = 79,
                                              height = 175,
                                              age = 35)
```

Modules that are intended to be used in combination with a variety of other modules,
especially with every generic PBPK module, are usually set up in a generic way 
and require some extensions to be used directly. For example, the module "Thyroid"
must be extended by the molecules of the model it will be used with. Similarly, some
compound-specific parameter could require manual adjustments. Therefore, intial conditions 
and parameter values building block can be modified from R.

Following functionalities are available for the Initial Conditions BBs:

- `setInitialConditions()`: Allows adding new entries or changing the values of existing
  entries in the Initial Conditions BB.
- `deleteInitialConditions()`: Allows deleting entries from the Initial Conditions BB.
- `extendInitialConditions()`: Extending an IC BB by entries for specified molecules
in all physical containers of a spatial structure.

Followning functionalities are available for the Parameter Values (PV) BBs:

- `setParameterValues()`: Allows adding new entries or changing the values of existing
  entries in the PV BB.
- `deleteParameterValues()`: Allows deleting entries from the PV BB.
- `addLocalMoleculeParameters()`: Extending a PV BB by entries for local parameters
of specified molecules in all physical containers of a spatial structure.
- `addProteinExpressionToParameterValuesBB()`: Extending a PV BB by parameters 
defining expression of protein molecules in selected organs.

So in the first step we load the extension module "Thyroid" from a pkml file:

```{r loadThyroidModule}
thyroidModule <- loadModuleFromPKML(system.file("extdata", "Thyroid.pkml", package = "ospsuite"))
```

Then we extend the initial conditions BB of the loaded module by molecules defined 
in the other modules of our project:

```{r extendICBB}
# Get the IC BB from the Thyroid module
icBB <- thyroidModule$getBuildingBlocks(type = "Initial Conditions")[[1]]
# Extend the IC BB of the module "Thyroid" with molecules from base module "Thyroid_QST"
newPaths <- extendInitialConditions(icBB,
                                    spatialStructureBB = thyroidModule$getBuildingBlocks(type = "Spacial Structure")[[1]],
                                    moleculesBB = thyroidModule$getBuildingBlocks(type = "Initial Conditions")[[1]],
                                    moleculeNames = NULL
```

# create simulation with new individual
# create simulation with new expression profiles
# Create individuals
# Create expression profiles
# selecting calculation methods for molecules!!!!
