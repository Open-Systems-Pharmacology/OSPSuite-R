# Set defaults
oldDefaults <- ospsuite.plots::setDefaults()
ggplot2::theme_update(legend.title = ggplot2::element_blank())

# `DataCombined` objects ------------------------

oneObsDC <- readRDS(getTestDataFilePath("oneObsDC"))
manyObsDC <- readRDS(getTestDataFilePath("manyObsDC"))

oneSimDC <- readRDS(getTestDataFilePath("oneSimDC"))
manySimDC <- readRDS(getTestDataFilePath("manySimDC"))

oneObsSimDC <- readRDS(getTestDataFilePath("oneObsSimDC"))
manyObsSimDC <- readRDS(getTestDataFilePath("manyObsSimDC"))

oneObsGeometricDC <- readRDS(getTestDataFilePath("oneObsGeometricDC"))

# convert to datatable and add errors as yMin and yMax to circumvent check for different dataTypes
manyObsDCdt <- manyObsDC$toDataFrame() %>%
  data.table::setDT()
manyObsDCdt[,`:=` (
  yMin = ifelse(yErrorType  == "GeometricStdDev",
                         yValues/yErrorValues,yValues + yErrorValues ),
  yMax = ifelse(yErrorType  == "GeometricStdDev",
               yValues*yErrorValues,yValues - yErrorValues ),
  yErrorValues = NULL,
  yErrorType = NULL)]

manyObsSimDCdt <- convertUnits(manyObsSimDC,
                               xUnit = ospUnits[['Time']][['h']],
                               yUnit = ospUnits[['Concentration [mass]']][['mg/l']]) %>%
  data.table::setDT()
manyObsSimDCdt[,`:=` (
  yMin = ifelse(yErrorType  == "GeometricStdDev",
                yValues/yErrorValues,yValues + yErrorValues ),
  yMax = ifelse(yErrorType  == "GeometricStdDev",
                yValues*yErrorValues,yValues - yErrorValues ),
  yErrorValues = NULL,
  yErrorType = NULL)]


### only observed ------------------------
test_that("It creates default plots as expected for single observed dataset", {
  set.seed(123)

  vdiffr::expect_doppelganger(
    title = "single obs",
    fig = plotTimeProfile(oneObsDC)
  )
})

test_that("It creates default plots as expected for multiple observed datasets", {
  set.seed(123)

  #It throws error if error Types ar not unique
  expect_error(plotTimeProfile(manyObsDC))


  vdiffr::expect_doppelganger(
    title = "multiple obs",
    fig = plotTimeProfile(manyObsDCdt)
  )


  vdiffr::expect_doppelganger(
    title = "multiple obs - separate legend",
    fig = plotTimeProfile(manyObsDCdt,
                          mapping = ggplot2::aes(groupby = name))
  )
})


# only simulated ------------------------

test_that("It creates default plots as expected for single simulated dataset", {
  set.seed(123)
  vdiffr::expect_doppelganger(
    title = "single sim",
    fig = plotTimeProfile(oneSimDC)
  )
})


test_that("It plots multiple simulated datasets with dataset name legend entries", {
  set.seed(123)
  vdiffr::expect_doppelganger(
    title = "multiple sim - separate legend",
    fig = plotTimeProfile(manySimDC,
                          mapping = ggplot2::aes(group = name,
                                                 linetype = name))
  )
})

# single observed and simulated datasets ------------------------

test_that("It creates default plots as expected for both observed and simulated", {
  set.seed(123)
  vdiffr::expect_doppelganger(
    title = "both - default",
    fig = plotTimeProfile(oneObsSimDC)
  )

})

# multiple observed and simulated datasets ------------------------

test_that("It maps multiple observed and simulated datasets to different visual properties", {

  set.seed(123)
  vdiffr::expect_doppelganger(
    title = "multiple obs and sim",
    fig = plotTimeProfile(manyObsSimDCdt,
                          yscale = 'log',
                          yscale.args = list(limits = c(0.001,NA)),
                          mapping = ggplot2::aes(groupby = name))
  )
})

# edge cases ------------------------

test_that("It works when geometric error is present", {
  set.seed(123)
  vdiffr::expect_doppelganger(
    title = "geometric error",
    fig = plotTimeProfile(oneObsGeometricDC)
  )
})

test_that("It returns `NULL` when `DataCombined` is empty", {
  myCombDat <- DataCombined$new()

  expect_error(suppressWarnings(plotTimeProfile(myCombDat)))
})

# LLOQ

test_that("LLOQ is plotted", {
  set.seed(42)
  dataSet <- DataSet$new("ds with lloq")
  dataSet$setValues(1:9,
                    c(10 * exp(1:-5) + rnorm(7, 0, .25),rep(0.075,2)),
                    c(abs(rnorm(7, 0, 0.2)),rep(NA,2)))
  dataSet$LLOQ <- 0.15


  dc <- DataCombined$new()
  dc$addDataSets(dataSet)


  vdiffr::expect_doppelganger(
    title = "lloq",
    fig = plotTimeProfile(dc,yscale = 'log',
                          mapping = ggplot2::aes(groupby = name))
  )

  noLLOQ_DPC <- DefaultPlotConfiguration$new()
  noLLOQ_DPC$displayLLOQ <- FALSE

  vdiffr::expect_doppelganger(
    title = "no lloq",
    fig = plotIndividualTimeProfile(dc, defaultPlotConfiguration = noLLOQ_DPC)
  )
})

ospsuite.plots::resetDefaults(oldDefaults)
