<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ospsuite">
<title>Efficient calculation â€¢ ospsuite</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Efficient calculation">
<meta property="og:description" content="ospsuite">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ospsuite</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">12.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/ospsuite.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Primary functions</h6>
    <a class="dropdown-item" href="../articles/load-get.html">Loading a simulation and accessing entities</a>
    <a class="dropdown-item" href="../articles/set-values.html">Changing parameter and molecule start values</a>
    <a class="dropdown-item" href="../articles/run-simulation.html">Running a simulation</a>
    <a class="dropdown-item" href="../articles/pk-analysis.html">Calculating PK parameters of simulation outputs</a>
    <a class="dropdown-item" href="../articles/sensitivity-analysis.html">Sensitivity analysis</a>
    <a class="dropdown-item" href="../articles/create-individual.html">Creating individuals</a>
    <a class="dropdown-item" href="../articles/create-run-population.html">Population simulations</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Figure creation</h6>
    <a class="dropdown-item" href="../articles/observed-data.html">Observed data</a>
    <a class="dropdown-item" href="../articles/data-combined.html">Working with `DataCombined` class</a>
    <a class="dropdown-item" href="../articles/data-combined-plotting.html">Visualizations with `DataCombined`</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Miscellaneous</h6>
    <a class="dropdown-item" href="../articles/efficient-calculations.html">Efficient calculation</a>
    <a class="dropdown-item" href="../articles/table-parameters.html">Table parameters</a>
    <a class="dropdown-item" href="../articles/unit-conversion.html">Dimensions and Units</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/open-systems-pharmacology/ospsuite-r/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Efficient calculation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/open-systems-pharmacology/ospsuite-r/blob/HEAD/vignettes/efficient-calculations.Rmd" class="external-link"><code>vignettes/efficient-calculations.Rmd</code></a></small>
      <div class="d-none name"><code>efficient-calculations.Rmd</code></div>
    </div>

    
    
<p>There are a few ways to run simulations using this package. The
easiest way is, as expected, not necessarily the most efficient one. So
depending on the use case, a different approach than what is outlined in
<a href="run-simulation.html">Run Simulations</a> might be more
suited.</p>
<p>This vignette aims at describing some scenarios and the suggested
methods to efficiently run simulations.</p>
<div class="section level2">
<h2 id="life-cycle-of-a-simulation-run">Life cycle of a simulation run<a class="anchor" aria-label="anchor" href="#life-cycle-of-a-simulation-run"></a>
</h2>
<p>In general, a user loads a simulation, updates some parameter values,
calculates the simulation and retrieves the results. Here are some steps
inherent to each simulation:</p>
<ol style="list-style-type: decimal">
<li>Loading a simulation</li>
<li>Optional: Setting parameter values</li>
<li>Optional: Setting initial values</li>
<li>Initializing the simulation engine</li>
<li>Solving the ODE System (calculating the outputs)</li>
</ol>
<p>Depending on the simulation of interest, some steps might take much
longer than others. For example, a simulation with multiple
administrations simulated over many months will load and initialize
quickly (1 and 4) while calculating (5) will be the critical step. On
the other hand, a simulation with dozens of compounds will also take
time to load and initialize (1 and 4).</p>
</div>
<div class="section level2">
<h2 id="running-a-single-simulation-once">Running a single simulation once<a class="anchor" aria-label="anchor" href="#running-a-single-simulation-once"></a>
</h2>
<p>This is by far the easiest use cases. A simulation is loaded from a
.pkml file and the outputs are calculated. In this use case, step 4 and
5 are automatically lumped together in one single call (See <a href="run-simulation.html">Run Simulations</a> for more details).</p>
<p><img src="images/simple_simulation.drawio.png"></p>
</div>
<div class="section level2">
<h2 id="running-a-single-simulation-multiple-times-and-varying-some-parametersinitial-values-between-each-run">Running a single simulation multiple times and varying some
parameters/initial values between each run<a class="anchor" aria-label="anchor" href="#running-a-single-simulation-multiple-times-and-varying-some-parametersinitial-values-between-each-run"></a>
</h2>
<p>This is already a use case where the optimal and most efficient way
depends drastically on the simulation at hand. Letâ€™s assume that we want
to calculate the outputs of a simulation for different doses.</p>
<p>A simple implementation could follow the following idea, where a
simulation is loaded once, the dose value is updated and the simulation
is calculated for each dose of interest.</p>
<p><img src="images/iterative_simulation.drawio.png"></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/open-systems-pharmacology/ospsuite-r" class="external-link">ospsuite</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: rClr</span></span>
<span><span class="co">#&gt; Loading the dynamic library for Microsoft .NET runtime...</span></span>
<span><span class="co">#&gt; Loaded Common Language Runtime version 4.0.30319.42000</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Load and run the simulation</span></span>
<span><span class="va">simFilePath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir.pkml"</span>, package <span class="op">=</span> <span class="st">"ospsuite"</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadSimulation.html">loadSimulation</a></span><span class="op">(</span><span class="va">simFilePath</span><span class="op">)</span></span>
<span><span class="va">doseParameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getAllParametersMatching.html">getAllParametersMatching</a></span><span class="op">(</span><span class="fu"><a href="../reference/toPathString.html">toPathString</a></span><span class="op">(</span><span class="st">"Applications"</span>, <span class="st">"**"</span>, <span class="st">"Dose"</span><span class="op">)</span>, <span class="va">sim</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># run for dose 100mg</span></span>
<span><span class="va">doseParameter</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/toBaseUnit.html">toBaseUnit</a></span><span class="op">(</span><span class="va">doseParameter</span>, <span class="fl">100</span>, <span class="st">"mg"</span><span class="op">)</span></span>
<span><span class="va">result100</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulations.html">runSimulations</a></span><span class="op">(</span>simulations <span class="op">=</span> <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run for dose 200mg</span></span>
<span><span class="va">doseParameter</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/toBaseUnit.html">toBaseUnit</a></span><span class="op">(</span><span class="va">doseParameter</span>, <span class="fl">200</span>, <span class="st">"mg"</span><span class="op">)</span></span>
<span><span class="va">result200</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulations.html">runSimulations</a></span><span class="op">(</span>simulations <span class="op">=</span> <span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ...</span></span>
<span></span>
<span><span class="co"># run for dose 500mg</span></span>
<span><span class="va">doseParameter</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/toBaseUnit.html">toBaseUnit</a></span><span class="op">(</span><span class="va">doseParameter</span>, <span class="fl">500</span>, <span class="st">"mg"</span><span class="op">)</span></span>
<span><span class="va">result500</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulations.html">runSimulations</a></span><span class="op">(</span>simulations <span class="op">=</span> <span class="va">sim</span><span class="op">)</span></span></code></pre></div>
<p>This implementation is fairly easy to understand, but has potentially
one big performance bottleneck. Each simulation run is performed
<strong>sequentially</strong> (i.e.Â one at a time). That means that
there will not be any performance boost from having multiple cores on
the machine. If the simulation only takes a few seconds to run, this
solution is absolutely acceptable. However, if we assume that a
simulation takes 1h to run, this code would take over 5h to complete, as
each <code>runSimulations</code> call would be executed
sequentially.</p>
<p>When the simulation run time (5) is much greater than the loading (1)
and initialization time (4), a better approach is to load the simulation
multiple times and run the simulation concurrently (i.e.Â in
parallel).</p>
<p><img src="images/parallel_simulation.drawio.png"></p>
<p>Consider the following implementation:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/open-systems-pharmacology/ospsuite-r" class="external-link">ospsuite</a></span><span class="op">)</span></span>
<span><span class="co"># Load and run the simulation</span></span>
<span><span class="va">simFilePath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir.pkml"</span>, package <span class="op">=</span> <span class="st">"ospsuite"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">loadSimulationWithDose</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doseInMg</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadSimulation.html">loadSimulation</a></span><span class="op">(</span><span class="va">simFilePath</span>, loadFromCache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">doseParameter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getAllParametersMatching.html">getAllParametersMatching</a></span><span class="op">(</span><span class="fu"><a href="../reference/toPathString.html">toPathString</a></span><span class="op">(</span><span class="st">"Applications"</span>, <span class="st">"**"</span>, <span class="st">"Dose"</span><span class="op">)</span>, <span class="va">sim</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">doseParameter</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/toBaseUnit.html">toBaseUnit</a></span><span class="op">(</span><span class="va">doseParameter</span>, <span class="va">doseInMg</span>, <span class="st">"mg"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Creates 5 instances of a simulation (This is very fast for typical simulations)</span></span>
<span><span class="va">sim100</span> <span class="op">&lt;-</span> <span class="fu">loadSimulationWithDose</span><span class="op">(</span>doseInMg <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">sim200</span> <span class="op">&lt;-</span> <span class="fu">loadSimulationWithDose</span><span class="op">(</span>doseInMg <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">sim300</span> <span class="op">&lt;-</span> <span class="fu">loadSimulationWithDose</span><span class="op">(</span>doseInMg <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="va">sim400</span> <span class="op">&lt;-</span> <span class="fu">loadSimulationWithDose</span><span class="op">(</span>doseInMg <span class="op">=</span> <span class="fl">400</span><span class="op">)</span></span>
<span><span class="va">sim500</span> <span class="op">&lt;-</span> <span class="fu">loadSimulationWithDose</span><span class="op">(</span>doseInMg <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Runs the simulation in parallel</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulations.html">runSimulations</a></span><span class="op">(</span>simulations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sim100</span>, <span class="va">sim200</span>, <span class="va">sim300</span>, <span class="va">sim400</span>, <span class="va">sim500</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Results in now a list of SimulationResults</span></span></code></pre></div>
<p>This implementation is also fairly straight forward. We load the
simulation multiple times from the same file (note the usage of
<code>loadFromCache = FALSE</code> to ensure that we always get a new
instance of a simulation and not the same instance) and we set the dose.
Then, we call the <code>runSimulations</code> function with the list of
simulations. The engine will run these simulations in parallel, which
means that the overall execution time should be slightly more than 1h,
as each run would be executed <strong>at the same time</strong>.</p>
</div>
<div class="section level2">
<h2 id="optimized-loading-for-running-simulations-with-predefined-set-of-variable-parameters">Optimized loading for running simulations with predefined set of
variable parameters<a class="anchor" aria-label="anchor" href="#optimized-loading-for-running-simulations-with-predefined-set-of-variable-parameters"></a>
</h2>
<p>This is a more advanced use case, typically when implementing some
kind of optimization or sensitivity algorithms. The
<a href="https://github.com/open-systems-pharmacology/ospsuite-r" class="external-link">ospsuite</a> package introduces the concept of a
<strong>simulation batch</strong>. With a simulation batch, the variable
parameters (or initial values) of a simulation to vary between each run
are specified explicitly during the creation of the simulation batch.
This allows the simulation engine to speed up the system significantly
as some equations can be rewritten and simplified. A simulation batch
also keeps the simplified simulation in memory. That means that running
a simulation again with a new set of values will be much faster, as the
initialization phase (4) is only done if required and not for every
run.</p>
<p><img src="images/batch_simulation.drawio.png"></p>
<p>Consider the following implementation. We first create two simulation
batches for the same model and define the parameter values that can be
changed between runs. Note that, as opposed to the
<code>Simulation</code> object, we do not have access to any
parameter/species values nor can we change the outputs or simulation
time.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/open-systems-pharmacology/ospsuite-r" class="external-link">ospsuite</a></span><span class="op">)</span></span>
<span><span class="va">simFilePath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir.pkml"</span>, package <span class="op">=</span> <span class="st">"ospsuite"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We load the simulation for which the batches will be created</span></span>
<span><span class="va">sim1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadSimulation.html">loadSimulation</a></span><span class="op">(</span><span class="va">simFilePath</span>, loadFromCache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define the list of parameter that will be varied between the runs.</span></span>
<span><span class="co"># For the first batch, we will vary 2 parameters: Lipophilicity and Permeability</span></span>
<span><span class="va">parameterPaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Aciclovir|Lipophilicity"</span>, <span class="st">"Aciclovir|Permeability"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define a first simulation batch</span></span>
<span><span class="va">simBatch1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSimulationBatch.html">createSimulationBatch</a></span><span class="op">(</span>simulation <span class="op">=</span> <span class="va">sim1</span>, parametersOrPaths <span class="op">=</span> <span class="va">parameterPaths</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># for the second batch, we will vary Molecular Weight</span></span>
<span><span class="va">simBatch2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSimulationBatch.html">createSimulationBatch</a></span><span class="op">(</span></span>
<span>  simulation <span class="op">=</span> <span class="va">sim1</span>,</span>
<span>  parametersOrPaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Aciclovir|Molecular weight"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulationBatches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">simBatch1</span>, <span class="va">simBatch2</span><span class="op">)</span></span></code></pre></div>
<p>In the next step, we define multiple runs of the simulation batch by
adding different parameter (and/or species start) values set. Each set
of values correspond to one run. The benefit of this approach is that
the initialization steps (1 and 4) are only performed once. After that,
only the execution time (step 5) will have an impact on the total
performance.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now setting some parameter run values (the size of the array should match</span></span>
<span><span class="co"># the number of parameters to vary for each batch</span></span>
<span><span class="va">simBatch1</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "dafa392a-1c1f-4ac0-b724-18f825d2c489"</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch1</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1b1e1555-915d-4f4d-af03-c32cd4b14c41"</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch1</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "f24ae4ac-d4e6-4197-aabc-68b6ac780c54"</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># We only have one parameter to vary for simBatch2, therefore only one value to set</span></span>
<span><span class="va">simBatch2</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">150</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "bf7bf882-2f3b-48b6-aeaf-d2f494bbe8c5"</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch2</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "ac765dab-a000-456e-8723-d5bcdf69e567"</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch2</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "6d0eb1b4-7849-43a1-ad88-d0db2b108ec5"</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch2</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "aa699cb5-8d34-45ea-ba9b-795ec3607ce0"</span></span></code></pre></div>
<p>So far, we created 2 simulation batches, one with 3 parameter sets
and the other one with 4. That means that 3 runs will be enqueued for
simBatch1 and 4 will be enqueued for simBatch2. Each run gets a unique
id that can later be used to correctly assign simulation results to the
simulated set of parameters.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Now we run the simulation batches.</span></span>
<span><span class="co"># By doing so, 7 runs (3 for simBatch1 and 4 for simBatch2) will be executed in parallel.</span></span>
<span><span class="co"># Please see documentation of runSimulationBatches for more details.</span></span>
<span><span class="co"># The resulting output is a named list, where the names are the ids of the enqueued runs.</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulationBatches.html">runSimulationBatches</a></span><span class="op">(</span><span class="va">simulationBatches</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "36a84380-a4d9-4b5a-a8a6-4ed3b7526008.dafa392a-1c1f-4ac0-b724-18f825d2c489"</span></span>
<span><span class="co">#&gt; [2] "36a84380-a4d9-4b5a-a8a6-4ed3b7526008.1b1e1555-915d-4f4d-af03-c32cd4b14c41"</span></span>
<span><span class="co">#&gt; [3] "36a84380-a4d9-4b5a-a8a6-4ed3b7526008.f24ae4ac-d4e6-4197-aabc-68b6ac780c54"</span></span>
<span><span class="co">#&gt; [4] "ed4dce12-93e7-456b-addf-7588b4f1b94e.bf7bf882-2f3b-48b6-aeaf-d2f494bbe8c5"</span></span>
<span><span class="co">#&gt; [5] "ed4dce12-93e7-456b-addf-7588b4f1b94e.ac765dab-a000-456e-8723-d5bcdf69e567"</span></span>
<span><span class="co">#&gt; [6] "ed4dce12-93e7-456b-addf-7588b4f1b94e.6d0eb1b4-7849-43a1-ad88-d0db2b108ec5"</span></span>
<span><span class="co">#&gt; [7] "ed4dce12-93e7-456b-addf-7588b4f1b94e.aa699cb5-8d34-45ea-ba9b-795ec3607ce0"</span></span></code></pre></div>
<p>The enqueued run values are cleared after calling
<code><a href="../reference/runSimulationBatches.html">runSimulationBatches()</a></code>, so executing the run again would
result in an empty results list. We can now set more values to the
batches and run them again. Notes: - We do not have to always set the
same number of values at the same time - Previous <code>runValues</code>
are automatically cleared when <code><a href="../reference/runSimulationBatches.html">runSimulationBatches()</a></code> is
called.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch1</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "8bdeff6d-cdcd-4059-bbdf-6ecd36ca5db2"</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch1</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1efec566-be7a-4f68-85f3-af2203e94218"</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch2</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "539e8cf6-1329-45e5-8d2b-25d695704abe"</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simBatch2</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "96e221e7-ddeb-485d-8ccd-5a4f18433d0d"</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># this run will be much faster as the simulation won't be initialized again.</span></span>
<span><span class="co"># Only the new value will be set as specified when adding new run values with addRunValues</span></span>
<span><span class="va">results2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulationBatches.html">runSimulationBatches</a></span><span class="op">(</span><span class="va">simulationBatches</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Once the simulation batches instances are not needed anymore, they can be removed</span></span>
<span><span class="co"># from the environment and the allocated memory cleared.</span></span>
<span><span class="co"># This will be done automatically when the R session is terminated.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">simBatch1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">simBatch2</span><span class="op">)</span></span></code></pre></div>
<p>Usage of <code>SimulationBatch</code> is recommended for advanced
scenarios where simulations expected to be run hundreds of times and
where each second that can be spared will impact the performance
significantly.</p>
<div class="section level3">
<h3 id="varying-state-variable-parameters-with-simulationbatch">Varying state variable parameters with SimulationBatch<a class="anchor" aria-label="anchor" href="#varying-state-variable-parameters-with-simulationbatch"></a>
</h3>
<p>State variable parameters, i.e., those defined by a right hand side
(RHS), are treated as molecules internally. Trying to create and run a
simulation batch with a state variable parameter set as a variable
parameter will result in an error:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stateVariableParam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getParameter.html">getParameter</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Organism|Lumen|Stomach|Liquid"</span>, container <span class="op">=</span> <span class="va">sim1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">stateVariableParam</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Organism|Lumen|Stomach|Liquid </span></span>
<span><span class="co">#&gt;    Value: 0.05 [l] </span></span>
<span><span class="co">#&gt;    isFormula: TRUE </span></span>
<span><span class="co">#&gt;    formula: V*SteadyStateFillLevel </span></span>
<span><span class="co">#&gt;    Value overrides formula: FALSE </span></span>
<span><span class="co">#&gt;    isStateVariable: TRUE </span></span>
<span><span class="co">#&gt;    RHSFormula: NULL </span></span>
<span><span class="co">#&gt;    isFormula: TRUE </span></span>
<span><span class="co">#&gt;    formula: OralApplicationsEnabled ? -LT_sto + Inflow*FillLevelFlag : 0</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create simulation batch with state variable parameter set as a variable parameter</span></span>
<span><span class="va">simBatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSimulationBatch.html">createSimulationBatch</a></span><span class="op">(</span>simulation <span class="op">=</span> <span class="va">sim1</span>, parametersOrPaths <span class="op">=</span> <span class="va">stateVariableParam</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add run values</span></span>
<span><span class="va">resId</span> <span class="op">&lt;-</span> <span class="va">simBatch</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>parameterValues <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co"># Try to run batch</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulationBatches.html">runSimulationBatches</a></span><span class="op">(</span><span class="va">simBatch</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in rClr::clrCall(simulationRunner, "RunConcurrently"): Type:    OSPSuite.Core.Domain.InvalidArgumentException</span></span>
<span><span class="co">#&gt; Message: Entities 'Organism|Lumen|Stomach|Liquid' do not exist in the simulation</span></span>
<span><span class="co">#&gt; Method:  Void validate(System.Collections.Generic.IReadOnlyList`1[System.String], System.Collections.Generic.IReadOnlyList`1[System.String])</span></span>
<span><span class="co">#&gt; Stack trace:</span></span>
<span><span class="co">#&gt;    at OSPSuite.R.Domain.SimulationBatch.validate(IReadOnlyList`1 entitiesToVary, IReadOnlyList`1 entitiesThatWillBeVaried)</span></span>
<span><span class="co">#&gt;    at OSPSuite.R.Domain.SimulationBatch.validate(SimulationBatchOptions simulationBatchOptions)</span></span>
<span><span class="co">#&gt;    at OSPSuite.R.Domain.SimulationBatch.Initialize(IModelCoreSimulation simulation, SimulationBatchOptions simulationBatchOptions, SimulationRunOptions simulationRunOptions)</span></span>
<span><span class="co">#&gt;    at OSPSuite.R.Domain.SimulationBatchFactory.Create(IModelCoreSimulation modelCoreSimulation, SimulationBatchOptions simulationBatchOptions, SimulationRunOptions simulationRunOptions)</span></span>
<span><span class="co">#&gt;    at OSPSuite.R.Domain.ConcurrentRunSimulationBatch.AddNewBatch(SimulationRunOptions simulationRunOptions)</span></span>
<span><span class="co">#&gt;    at OSPSuite.R.Servi</span></span></code></pre></div>
<p>Instead, the state variable parameter should be treated as a species
and set as a variable molecule start value.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create simulation batch with state variable parameter set as a variable molecule</span></span>
<span><span class="va">simBatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSimulationBatch.html">createSimulationBatch</a></span><span class="op">(</span>simulation <span class="op">=</span> <span class="va">sim1</span>, moleculesOrPaths <span class="op">=</span> <span class="va">stateVariableParam</span><span class="op">)</span></span>
<span><span class="co"># Add run values</span></span>
<span><span class="va">resId</span> <span class="op">&lt;-</span> <span class="va">simBatch</span><span class="op">$</span><span class="fu">addRunValues</span><span class="op">(</span>initialValues <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co"># Try to run batch</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSimulationBatches.html">runSimulationBatches</a></span><span class="op">(</span><span class="va">simBatch</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Sevestre, Pavel Balazki, Juri Solodenko, <a href="https://sites.google.com/site/indrajeetspatilmorality/" class="external-link">Indrajeet Patil</a>, Felix MIL.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
